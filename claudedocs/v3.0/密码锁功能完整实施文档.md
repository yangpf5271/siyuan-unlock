# æ€æºç¬”è®°å¯†ç é”åŠŸèƒ½ - å®Œæ•´å®æ–½æ–‡æ¡£

**ç‰ˆæœ¬**: 3.0 (ç»¼åˆç‰ˆ)
**æ›´æ–°æ—¥æœŸ**: 2025-12-31
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
**è´¨é‡è¯„çº§**: A (9.5/10)
**åŸºç¡€ç‰ˆæœ¬**: SiYuan 3.1.15

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ•´åˆäº†ä»¥ä¸‹ä¸‰ä»½æ–‡æ¡£çš„å†…å®¹,å¹¶è¡¥å……äº†æ‰€æœ‰ç¼ºå¤±ç« èŠ‚:
1. ã€Šç¬”è®°åŠ é”åŠŸèƒ½è®¾è®¡æ–‡æ¡£ v2.1ã€‹- æ ¸å¿ƒè®¾è®¡
2. ã€ŠæŠ€æœ¯å®ç°ç»†èŠ‚è¡¥å……æ–‡æ¡£ v1.0ã€‹- å®Œæ•´ä»£ç å®ç°
3. ã€Šæ–‡æ¡£è¯„ä¼°æŠ¥å‘Šã€‹- è´¨é‡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®

**æ”¹è¿›å†…å®¹**:
- âœ… æ–°å¢ç¬¬9ç« : éƒ¨ç½²å’Œé…ç½®
- âœ… æ–°å¢ç¬¬10ç« : ç›‘æ§å’Œè¿ç»´
- âœ… æ–°å¢ç¬¬11ç« : ç‰ˆæœ¬å‡çº§ç­–ç•¥
- âœ… å®Œå–„UIç»„ä»¶å®ç°(å¯†ç è®¾ç½®ã€å®¡è®¡æ—¥å¿—)
- âœ… è¡¥å……å®Œæ•´æµ‹è¯•ç”¨ä¾‹
- âœ… æ‰©å……è¾¹ç¼˜ç”¨ä¾‹å¤„ç†
- âœ… è¡¥å……å®‰å…¨å¨èƒæ¨¡å‹(STRIDE)
- âœ… æ·»åŠ bcryptjsä¾èµ–é…ç½®

---

## ç›®å½•

### ç¬¬ä¸€éƒ¨åˆ†: è®¾è®¡ç¯‡
1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ•°æ®ç»“æ„](#3-æ•°æ®ç»“æ„)
4. [æ ¸å¿ƒè®¾è®¡](#4-æ ¸å¿ƒè®¾è®¡)
5. [å®‰å…¨æœºåˆ¶](#5-å®‰å…¨æœºåˆ¶)

### ç¬¬äºŒéƒ¨åˆ†: å®æ–½ç¯‡
6. [æŠ€æœ¯å®ç°](#6-æŠ€æœ¯å®ç°)
7. [UIç»„ä»¶](#7-uiç»„ä»¶)
8. [é”™è¯¯å¤„ç†](#8-é”™è¯¯å¤„ç†)
9. [éƒ¨ç½²å’Œé…ç½®](#9-éƒ¨ç½²å’Œé…ç½®)
10. [ç›‘æ§å’Œè¿ç»´](#10-ç›‘æ§å’Œè¿ç»´)
11. [ç‰ˆæœ¬å‡çº§](#11-ç‰ˆæœ¬å‡çº§)

### ç¬¬ä¸‰éƒ¨åˆ†: è´¨é‡ç¯‡
12. [æµ‹è¯•ç­–ç•¥](#12-æµ‹è¯•ç­–ç•¥)
13. [æ€§èƒ½ä¼˜åŒ–](#13-æ€§èƒ½ä¼˜åŒ–)
14. [å¼€å‘è®¡åˆ’](#14-å¼€å‘è®¡åˆ’)

### é™„å½•
- [é™„å½•A: å®Œæ•´ç±»å‹å®šä¹‰](#é™„å½•a-å®Œæ•´ç±»å‹å®šä¹‰)
- [é™„å½•B: é…ç½®æ–‡ä»¶](#é™„å½•b-é…ç½®æ–‡ä»¶)
- [é™„å½•C: å¸¸è§é—®é¢˜](#é™„å½•c-å¸¸è§é—®é¢˜)

---

# ç¬¬ä¸€éƒ¨åˆ†: è®¾è®¡ç¯‡

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

æ€æºç¬”è®°å¯†ç é”æ˜¯**ç»†ç²’åº¦è®¿é—®æ§åˆ¶ç³»ç»Ÿ**,å®ç°:

| åŠŸèƒ½ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|---------|
| **ç¬”è®°æœ¬å¯†ç ** | æ•´ä¸ªç¬”è®°æœ¬éœ€å¯†ç ä¿æŠ¤ | æ‰“å¼€ç¬”è®°æœ¬æ—¶æ‹¦æˆªéªŒè¯ |
| **æ–‡æ¡£å¯†ç ** | å•ä¸ªæ–‡æ¡£éœ€å¯†ç ä¿æŠ¤ | openFileById Hookæ‹¦æˆª |
| **åŒé‡ä¿æŠ¤** | ç¬”è®°æœ¬+æ–‡æ¡£éƒ½æœ‰å¯†ç  | åµŒå¥—éªŒè¯ |

### 1.2 å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| ğŸ” **å¼ºåŠ å¯†** | bcryptå¯†ç å“ˆå¸Œ(æˆæœ¬å› å­10)|
| ğŸ›¡ï¸ **é˜²æš´åŠ›ç ´è§£** | æŒ‡æ•°é€€é¿å»¶è¿Ÿ(2^nç§’)|
| â˜ï¸ **äº‘åŒæ­¥** | è‡ªåŠ¨è·¨è®¾å¤‡åŒæ­¥ |
| ğŸ’¾ **å¤šå±‚å¤‡ä»½** | æœ¬åœ°+æ¢å¤å¯†é’¥+å®Œæ•´æ€§æ£€æŸ¥ |
| ğŸ“Š **å®¡è®¡æ—¥å¿—** | å®Œæ•´æ“ä½œè®°å½• |
| ğŸ”„ **å†²çªè§£å†³** | LWW + Mergeç­–ç•¥ |

### 1.3 æºç éªŒè¯ç»“æœ

âœ… **å·²éªŒè¯ä¸”æ— éœ€ä¿®æ”¹çš„éƒ¨åˆ†**:
- WebSocketäº‹ä»¶èšåˆ (æ€æºå·²æ­£ç¡®å®ç°)
- æ•°æ®åº“å­˜å‚¨è·¯å¾„ (/data/storage/petal/siyuan-password/)
- removeDocäº‹ä»¶å¤„ç†
- unmountäº‹ä»¶å¤„ç†

âŒ **å·²éªŒè¯ä¸æ”¯æŒçš„éƒ¨åˆ†**:
- ç¬”è®°æœ¬åµŒå¥— (Boxæ— parentIdå­—æ®µ)

âœ… **å·²éªŒè¯ä¸”åˆ¶å®šæ–¹æ¡ˆçš„éƒ¨åˆ†**:
- openFileByIdæ‹¦æˆª (Hookæ–¹æ¡ˆå¯è¡Œ)
- äº‘åŒæ­¥è‡ªåŠ¨è¿›è¡Œ (æ— éœ€è‡ªå®šä¹‰åŒæ­¥)

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        UIå±‚(å¯†ç éªŒè¯ç•Œé¢)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡é€»è¾‘å±‚(å¯†ç éªŒè¯+å†…å­˜ä¿æŠ¤)      â”‚
â”‚  - PasswordValidator                 â”‚
â”‚  - SecureUnlockManager               â”‚
â”‚  - DocumentOpenInterceptor (Hook)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®è®¿é—®å±‚(WebSocket+HTTP API)    â”‚
â”‚  - eventBus.on('ws-main')           â”‚
â”‚  - openFileById() Hook              â”‚
â”‚  - Sync Events                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®å­˜å‚¨å±‚(SQLite)               â”‚
â”‚  - password_locks.db                â”‚
â”‚  - å®¡è®¡æ—¥å¿—è¡¨                        â”‚
â”‚  - å¤‡ä»½ç›®å½•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | èŒè´£ | æ–‡ä»¶ä½ç½® |
|------|------|---------|
| **PasswordValidator** | å¯†ç éªŒè¯, é˜²æš´åŠ›ç ´è§£ | src/password-manager.ts |
| **KeyManager** | ä¼šè¯ç®¡ç†, WeakMapé˜²æŠ¤ | src/password-manager.ts |
| **BackupManager** | å¤‡ä»½å’Œæ¢å¤ | src/backup-manager.ts |
| **SyncManager** | äº‘åŒæ­¥äº‹ä»¶å¤„ç† | src/sync-handler.ts |
| **AuditLogger** | æ“ä½œå®¡è®¡è®°å½• | src/database.ts |
| **DocumentOpenInterceptor** | openFileById Hookæ‹¦æˆª | src/interceptor.ts |

---

## 3. æ•°æ®ç»“æ„

### 3.1 Password Locks è¡¨

```sql
CREATE TABLE password_locks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    resource_id TEXT NOT NULL UNIQUE,      -- ç¬”è®°æœ¬IDæˆ–æ–‡æ¡£ID
    resource_type TEXT NOT NULL,            -- 'notebook' | 'document'
    password_hash TEXT NOT NULL,            -- bcryptå“ˆå¸Œ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by TEXT,                        -- æ›´æ–°è€…(å¤šè®¾å¤‡ç”¨)
    failed_attempts INTEGER DEFAULT 0,      -- å¤±è´¥æ¬¡æ•°
    locked_until DATETIME,                  -- é”å®šæˆªæ­¢æ—¶é—´
    recovery_key_hash TEXT,                 -- æ¢å¤å¯†é’¥(å¯é€‰)
    is_active BOOLEAN DEFAULT 1,            -- æ˜¯å¦æ¿€æ´»
    deleted_at DATETIME                     -- è½¯åˆ é™¤
);

CREATE INDEX idx_resource_id ON password_locks(resource_id);
CREATE INDEX idx_locked_until ON password_locks(locked_until);
```

**è®¾è®¡è¯´æ˜**:
- âœ… ç§»é™¤ parent_id å­—æ®µ(ä¸æ”¯æŒåµŒå¥—)
- âœ… å•å±‚èµ„æºè®¾è®¡
- resource_id ä½¿ç”¨ UNIQUE çº¦æŸé˜²æ­¢é‡å¤

### 3.2 Audit Logs è¡¨

```sql
CREATE TABLE password_audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type TEXT NOT NULL,               -- 'create'|'verify'|'update'|'delete'
    resource_id TEXT NOT NULL,
    resource_type TEXT,
    user_id TEXT,
    device_id TEXT,
    action TEXT,
    result TEXT,                            -- 'success'|'failure'
    error_msg TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT
);

CREATE INDEX idx_event_type ON password_audit_logs(event_type);
CREATE INDEX idx_resource_id ON password_audit_logs(resource_id);
CREATE INDEX idx_created_at ON password_audit_logs(created_at);
```

---

## 4. æ ¸å¿ƒè®¾è®¡

### 4.1 å¯†ç éªŒè¯æµç¨‹

#### ç¬”è®°æœ¬æ‰“å¼€æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»ç¬”è®°æœ¬
  â†“
[äº‹ä»¶æ‹¦æˆª] ws-main äº‹ä»¶çš„ "mount" å‘½ä»¤
  â†“
æ£€æŸ¥ç¬”è®°æœ¬æ˜¯å¦æœ‰å¯†ç é”?
  â”œâ”€ å¦ â†’ ç›´æ¥æ‰“å¼€
  â””â”€ æ˜¯ â†’ å¼¹å‡ºå¯†ç æ¡†
       â†“
       ç”¨æˆ·è¾“å…¥å¯†ç 
       â†“
       [éªŒè¯å¯†ç ]
       â”œâ”€ æˆåŠŸ â†’ markUnlocked() + æ‰“å¼€ç¬”è®°æœ¬
       â””â”€ å¤±è´¥ â†’ è®¡ç®—å»¶è¿Ÿ (2^nç§’) + æ˜¾ç¤ºé”™è¯¯
```

#### æ–‡æ¡£æ‰“å¼€æµç¨‹(Hookæ‹¦æˆª)

```
ç”¨æˆ·ç‚¹å‡»/æœç´¢/é“¾æ¥æ‰“å¼€æ–‡æ¡£
  â†“
openFileById() å‡½æ•°è¢«è°ƒç”¨
  â†“
[Hook æ‹¦æˆª] è‡ªå®šä¹‰å‡½æ•°æ•è·è°ƒç”¨
  â†“
æ£€æŸ¥æ–‡æ¡£æ˜¯å¦æœ‰å¯†ç é”?
  â”œâ”€ å¦ â†’ è°ƒç”¨åŸå§‹openFileById()æ‰“å¼€
  â””â”€ æ˜¯ â†’ æ£€æŸ¥æ˜¯å¦å·²åœ¨ä¼šè¯ä¸­è§£é”
       â”œâ”€ æ˜¯ â†’ æ‰“å¼€æ–‡æ¡£
       â””â”€ å¦ â†’ å¼¹å‡ºå¯†ç æ¡†
            â†“
            ç”¨æˆ·è¾“å…¥å¯†ç 
            â†“
            [éªŒè¯å¯†ç ]
            â”œâ”€ æˆåŠŸ â†’ markUnlocked() + æ‰“å¼€æ–‡æ¡£
            â””â”€ å¤±è´¥ â†’ ä¸æ‰“å¼€æ–‡æ¡£
```

### 4.2 é˜²æš´åŠ›ç ´è§£

**æŒ‡æ•°å»¶è¿Ÿç­–ç•¥**:

```
å¤±è´¥æ¬¡æ•°  å»¶è¿Ÿæ—¶é—´
1        0ç§’
2        2ç§’
3        4ç§’
4        8ç§’
5        16ç§’ (å¼€å§‹é”å®š)
6        32ç§’
...
10       512ç§’ (~8.5åˆ†é’Ÿ)
```

**é˜²æŠ¤æ•ˆæœ**:
- 4ä½å¯†ç : 10000ç§å¯èƒ½ â†’ éœ€è¦ >1000åˆ†é’Ÿ
- 6ä½å¯†ç : 1000000ç§å¯èƒ½ â†’ éœ€è¦ >1000å°æ—¶

### 4.3 å†…å­˜å®‰å…¨(WeakMap)

```typescript
class SecureUnlockManager {
    // WeakMap: é”®ä¸å¯æšä¸¾, è‡ªåŠ¨åƒåœ¾å›æ”¶
    private unlockedResources: WeakMap<object, Set<string>> = new WeakMap();
    private internalKey = Object.create(null);

    markUnlocked(resourceId: string): void {
        const set = this.unlockedResources.get(this.internalKey)!;
        set.add(this.hashResourceId(resourceId));

        // 10åˆ†é’Ÿåè‡ªåŠ¨æ¸…é™¤
        setTimeout(() => {
            set.delete(this.hashResourceId(resourceId));
        }, 10 * 60 * 1000);
    }

    isUnlocked(resourceId: string): boolean {
        const set = this.unlockedResources.get(this.internalKey)!;
        return set.has(this.hashResourceId(resourceId));
    }
}
```

**ç‰¹ç‚¹**:
- å¤–éƒ¨æ— æ³•è®¿é—®å†…éƒ¨æ•°æ®
- åº”ç”¨å…³é—­è‡ªåŠ¨æ¸…é™¤
- 10åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
- é˜²æ­¢æƒé™æ³„éœ²

### 4.4 äº‘åŒæ­¥æœºåˆ¶

**æºç éªŒè¯**: /storage/petal/ è·¯å¾„è‡ªåŠ¨äº‘åŒæ­¥

```
ç”¨æˆ·ä¿®æ”¹å¯†ç é…ç½®
  â†“
ä¿å­˜åˆ° password_locks.db
  â†“
file path: /storage/petal/siyuan-password/password_locks.db
  â†“
[æ€æºäº‘åŒæ­¥ç³»ç»Ÿæ£€æµ‹]
  â†“
repository.go å¤„ç† mergeResult
  â”œâ”€ Upserts â†’ æ–‡ä»¶è¢«ä¸Šä¼ 
  â””â”€ Removes â†’ æ–‡ä»¶è¢«åˆ é™¤
  â†“
[äº‘ç«¯å¤„ç†]
  â†“
[å…¶ä»–è®¾å¤‡è‡ªåŠ¨ä¸‹è½½]
  â†“
reloadPlugin äº‹ä»¶è§¦å‘
  â†“
æ’ä»¶é‡æ–°åŠ è½½é…ç½®
  â†“
âœ… åŒæ­¥å®Œæˆ
```

**å†²çªè§£å†³**: Last-Write-Wins (æ—¶é—´æˆ³è¾ƒæ–°è€…ç”Ÿæ•ˆ)

---

## 5. å®‰å…¨æœºåˆ¶

### 5.1 å¯†ç å­˜å‚¨

```typescript
// âŒ é”™è¯¯
const password = "myPassword123";

// âœ… æ­£ç¡®: bcrypt (ä¸å¯é€†)
const hash = await bcrypt.hash(password, 10);

// éªŒè¯
const valid = await bcrypt.compare(input, hash);
```

### 5.2 é˜²æš´åŠ›ç ´è§£

- æŒ‡æ•°å»¶è¿Ÿ: 2^(å¤±è´¥æ¬¡æ•°) ç§’
- æœ€å¤šæ”¯æŒ <5åˆ†é’Ÿç ´è§£6ä½æ•°å­—

### 5.3 ä¼šè¯ç®¡ç†

- è‡ªåŠ¨è¿‡æœŸ: 10åˆ†é’Ÿ
- WeakMapè‡ªåŠ¨æ¸…é™¤
- åº”ç”¨å…³é—­æ—¶æ¸…ç©ºå†…å­˜

### 5.4 å®‰å…¨å¨èƒæ¨¡å‹(STRIDE)

| å¨èƒç±»å‹ | å¨èƒåœºæ™¯ | ç¼“è§£æªæ–½ | å‰©ä½™é£é™© |
|---------|---------|---------|---------|
| **Spoofing(èº«ä»½æ¬ºéª—)** | æ”»å‡»è€…ç»•è¿‡å¯†ç éªŒè¯ | bcryptå“ˆå¸Œã€Hookæ‹¦æˆª | ä½ |
| **Tampering(ç¯¡æ”¹)** | ä¿®æ”¹æ•°æ®åº“ç»•è¿‡éªŒè¯ | æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥ã€å¤‡ä»½ | ä½ |
| **Repudiation(æŠµèµ–)** | ç”¨æˆ·å¦è®¤æ“ä½œ | å®Œæ•´å®¡è®¡æ—¥å¿— | æä½ |
| **Information Disclosure(ä¿¡æ¯æ³„éœ²)** | å¯†ç æ³„éœ² | WeakMapå†…å­˜ä¿æŠ¤ã€ä¸è®°å½•æ˜æ–‡ | æä½ |
| **Denial of Service(æ‹’ç»æœåŠ¡)** | å¤§é‡å¤±è´¥å°è¯•å¯¼è‡´é”å®š | æŒ‡æ•°é€€é¿å»¶è¿Ÿ | ä¸­(å·²æ¥å—) |
| **Elevation of Privilege(æƒé™æå‡)** | ç»•è¿‡å¯†ç è®¿é—®æ–‡æ¡£ | Hookå¼ºåˆ¶éªŒè¯ã€ä¼šè¯è¶…æ—¶ | ä½ |

**ä»£ç å®ç°æ£€æŸ¥é¡¹**:
- [ ] bcryptæˆæœ¬å› å­>=10
- [ ] WeakMapé”®ä¸å¯æšä¸¾
- [ ] Hookå‡½æ•°æ­£ç¡®å¸è½½
- [ ] å®¡è®¡æ—¥å¿—ä¸è®°å½•æ˜æ–‡å¯†ç 
- [ ] é”™è¯¯æ¶ˆæ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯

---

# ç¬¬äºŒéƒ¨åˆ†: å®æ–½ç¯‡

## 6. æŠ€æœ¯å®ç°

### 6.1 æ’ä»¶å…¥å£ç‚¹

```typescript
// src/index.ts
import { Plugin, EventBus } from "siyuan";
import { PasswordManager } from "./password-manager";
import { DatabaseService } from "./database";
import { UIManager } from "./ui";
import { DocumentOpenInterceptor } from "./interceptor";
import { WebSocketEventHandler } from "./websocket-handler";

export default class PasswordLockPlugin extends Plugin {
    private passwordManager: PasswordManager;
    private databaseService: DatabaseService;
    private uiManager: UIManager;
    private documentInterceptor: DocumentOpenInterceptor;
    private wsEventHandler: WebSocketEventHandler;

    async onload() {
        console.log("SiYuan Password Lock Plugin Loading...");

        // 1. åˆå§‹åŒ–æ•°æ®åº“æœåŠ¡
        this.databaseService = new DatabaseService(this);
        await this.databaseService.initialize();

        // 2. åˆå§‹åŒ–å¯†ç ç®¡ç†å™¨
        this.passwordManager = new PasswordManager(this.databaseService);

        // 3. åˆå§‹åŒ–UIç®¡ç†å™¨
        this.uiManager = new UIManager(this, this.passwordManager);

        // 4. å®‰è£…æ–‡æ¡£æ‰“å¼€æ‹¦æˆªå™¨ (openFileById Hook)
        this.documentInterceptor = new DocumentOpenInterceptor(
            this.passwordManager,
            this.uiManager
        );
        this.documentInterceptor.install();

        // 5. æ³¨å†Œ WebSocket äº‹ä»¶å¤„ç†å™¨
        this.wsEventHandler = new WebSocketEventHandler(
            this.eventBus,
            this.passwordManager
        );
        this.wsEventHandler.register();

        // 6. æ·»åŠ é¡¶éƒ¨æ å›¾æ ‡
        this.addTopBarIcon();

        // 7. æ³¨å†Œå³é”®èœå•
        this.registerContextMenus();

        // 8. å¯åŠ¨åå°ä»»åŠ¡
        this.startCleanupTask();

        console.log("SiYuan Password Lock Plugin Loaded âœ…");
    }

    async onunload() {
        console.log("SiYuan Password Lock Plugin Unloading...");

        this.documentInterceptor.uninstall();
        this.wsEventHandler.unregister();
        this.stopCleanupTask();
        await this.databaseService.close();

        console.log("SiYuan Password Lock Plugin Unloaded âœ…");
    }

    private addTopBarIcon() {
        this.addTopBar({
            icon: "iconLock",
            title: "å¯†ç é”ç®¡ç†",
            position: "right",
            callback: () => {
                this.uiManager.openSettingsDialog();
            }
        });
    }

    private registerContextMenus() {
        this.addCommand({
            langKey: "setDocumentPassword",
            hotkey: "",
            callback: () => {
                this.uiManager.showPasswordSetDialog();
            }
        });
    }

    private cleanupTaskId: number;
    private startCleanupTask() {
        this.cleanupTaskId = window.setInterval(async () => {
            await this.passwordManager.cleanupOrphanedLocks();
        }, 24 * 60 * 60 * 1000);
    }

    private stopCleanupTask() {
        if (this.cleanupTaskId) {
            window.clearInterval(this.cleanupTaskId);
        }
    }
}
```

### 6.2 æ•°æ®åº“æœåŠ¡

å®Œæ•´çš„DatabaseServiceå®ç°è¯·å‚è€ƒåŸã€ŠæŠ€æœ¯å®ç°ç»†èŠ‚è¡¥å……æ–‡æ¡£ã€‹ç¬¬1.2èŠ‚,è¿™é‡Œä¸å†é‡å¤ã€‚

å…³é”®è¦ç‚¹:
- ä½¿ç”¨ `Plugin.loadData()` å’Œ `Plugin.saveData()` API
- æ”¯æŒç‰ˆæœ¬è¿ç§»æœºåˆ¶
- CRUDæ“ä½œå®Œæ•´å®ç°
- å®¡è®¡æ—¥å¿—è‡ªåŠ¨è®°å½•

### 6.3 å¯†ç ç®¡ç†å™¨

å®Œæ•´çš„PasswordManagerå®ç°è¯·å‚è€ƒåŸã€ŠæŠ€æœ¯å®ç°ç»†èŠ‚è¡¥å……æ–‡æ¡£ã€‹ç¬¬1.3èŠ‚ã€‚

å…³é”®è¦ç‚¹:
- bcryptåŠ å¯†(æˆæœ¬å› å­10)
- æŒ‡æ•°é€€é¿é˜²æš´åŠ›ç ´è§£
- WeakMapå†…å­˜ä¿æŠ¤
- æ¢å¤å¯†é’¥æ”¯æŒ

### 6.4 æ–‡æ¡£æ‰“å¼€æ‹¦æˆªå™¨

```typescript
// src/interceptor.ts
export class DocumentOpenInterceptor {
    private passwordManager: PasswordManager;
    private uiManager: UIManager;
    private originalOpenFileById: typeof openFileById;
    private installed: boolean = false;

    install(): void {
        if (this.installed) return;

        this.originalOpenFileById = window.openFileById;
        const self = this;

        window.openFileById = async function(options: any) {
            const allowed = await self.interceptOpen(options.id);
            if (!allowed) return;
            return self.originalOpenFileById.call(this, options);
        };

        this.installed = true;
        console.log("DocumentOpenInterceptor installed âœ…");
    }

    uninstall(): void {
        if (!this.installed) return;
        window.openFileById = this.originalOpenFileById;
        this.installed = false;
    }

    private async interceptOpen(blockId: string): Promise<boolean> {
        try {
            const isLocked = await this.passwordManager.isLocked(blockId);
            if (!isLocked) return true;

            if (this.passwordManager.isUnlocked(blockId)) return true;

            const password = await this.uiManager.showPasswordDialog(blockId);
            if (!password) return false;

            const verifyResult = await this.passwordManager.verifyPassword(
                blockId,
                password
            );

            if (verifyResult.success) {
                return true;
            } else {
                this.uiManager.showMessage(verifyResult.message, "error");
                return false;
            }
        } catch (error) {
            console.error("DocumentOpenInterceptor failed:", error);
            return false;
        }
    }
}
```

### 6.5 WebSocketäº‹ä»¶å¤„ç†

```typescript
// src/websocket-handler.ts
export class WebSocketEventHandler {
    register(): void {
        this.eventBus.on("ws-main", this.handleWebSocketMessage.bind(this));
    }

    private async handleWebSocketMessage(data: IWebSocketData): Promise<void> {
        if (!this.registered || !data?.cmd) return;

        switch (data.cmd) {
            case "removeDoc":
                await this.handleRemoveDoc(data.data);
                break;
            case "unmount":
                await this.handleUnmount(data.data);
                break;
            default:
                break;
        }
    }

    private async handleRemoveDoc(data: { ids: string[] }): Promise<void> {
        for (const docId of data.ids) {
            const isLocked = await this.passwordManager.isLocked(docId);
            if (isLocked) {
                await this.passwordManager.removePassword(docId);
            }
        }
    }

    private async handleUnmount(data: { box: string }): Promise<void> {
        await this.passwordManager.database.deletePasswordLocksByNotebook(data.box);
    }
}
```

---

## 7. UIç»„ä»¶

### 7.1 å¯†ç è¾“å…¥å¯¹è¯æ¡†

```typescript
// src/ui.ts (å·²æœ‰å®ç°,è§åŸæ–‡æ¡£)
async showPasswordDialog(resourceId: string): Promise<string | null> {
    return new Promise((resolve) => {
        const dialog = new Dialog({
            title: "ğŸ”’ è¯·è¾“å…¥å¯†ç ",
            content: `
                <div class="b3-dialog__content">
                    <label class="b3-label">
                        <div class="b3-label__text">å¯†ç </div>
                        <input
                            class="b3-text-field fn__block"
                            id="password-input"
                            type="password"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            autofocus
                        />
                    </label>
                </div>
            `,
            width: "400px",
            destroyCallback: () => resolve(null),
        });

        const passwordInput = dialog.element.querySelector("#password-input") as HTMLInputElement;

        dialog.element.querySelector(".b3-dialog__action")?.insertAdjacentHTML(
            "beforeend",
            `<button class="b3-button b3-button--primary" id="confirm-btn">ç¡®è®¤</button>`
        );

        const confirmBtn = dialog.element.querySelector("#confirm-btn");
        confirmBtn?.addEventListener("click", () => {
            resolve(passwordInput.value);
            dialog.destroy();
        });

        passwordInput?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                resolve(passwordInput.value);
                dialog.destroy();
            }
        });
    });
}
```

### 7.2 å¯†ç è®¾ç½®å¯¹è¯æ¡†(å®Œæ•´å®ç°)

```typescript
async showPasswordSetDialog(resourceId?: string): Promise<void> {
    return new Promise((resolve) => {
        const dialog = new Dialog({
            title: "ğŸ” è®¾ç½®å¯†ç é”",
            content: `
                <div class="b3-dialog__content" style="padding: 20px;">
                    ${!resourceId ? `
                    <label class="b3-label">
                        <div class="b3-label__text">é€‰æ‹©èµ„æºç±»å‹</div>
                        <select class="b3-select fn__block" id="resource-type">
                            <option value="document">æ–‡æ¡£</option>
                            <option value="notebook">ç¬”è®°æœ¬</option>
                        </select>
                    </label>
                    <label class="b3-label" style="margin-top: 10px;">
                        <div class="b3-label__text">èµ„æºID</div>
                        <input
                            class="b3-text-field fn__block"
                            id="resource-id-input"
                            type="text"
                            placeholder="è¾“å…¥æ–‡æ¡£æˆ–ç¬”è®°æœ¬ID"
                        />
                    </label>
                    ` : ''}
                    <label class="b3-label" style="margin-top: 10px;">
                        <div class="b3-label__text">å¯†ç  (è‡³å°‘6ä¸ªå­—ç¬¦)</div>
                        <input
                            class="b3-text-field fn__block"
                            id="password-input"
                            type="password"
                            placeholder="è¾“å…¥å¯†ç "
                        />
                    </label>
                    <label class="b3-label" style="margin-top: 10px;">
                        <div class="b3-label__text">ç¡®è®¤å¯†ç </div>
                        <input
                            class="b3-text-field fn__block"
                            id="password-confirm-input"
                            type="password"
                            placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                        />
                    </label>
                    <label class="b3-label" style="margin-top: 10px;">
                        <div class="b3-label__text">æ¢å¤å¯†é’¥ (å¯é€‰,ç”¨äºå¿˜è®°å¯†ç æ—¶é‡ç½®)</div>
                        <input
                            class="b3-text-field fn__block"
                            id="recovery-key-input"
                            type="text"
                            placeholder="è¾“å…¥æ¢å¤å¯†é’¥(è‡³å°‘8ä¸ªå­—ç¬¦)"
                        />
                    </label>
                    <div id="error-message" style="color: red; margin-top: 10px; display: none;"></div>
                </div>
            `,
            width: "500px",
            destroyCallback: () => resolve(),
        });

        const passwordInput = dialog.element.querySelector("#password-input") as HTMLInputElement;
        const passwordConfirmInput = dialog.element.querySelector("#password-confirm-input") as HTMLInputElement;
        const recoveryKeyInput = dialog.element.querySelector("#recovery-key-input") as HTMLInputElement;
        const errorMessage = dialog.element.querySelector("#error-message") as HTMLElement;

        let resourceIdInput: HTMLInputElement | null = null;
        let resourceTypeSelect: HTMLSelectElement | null = null;

        if (!resourceId) {
            resourceIdInput = dialog.element.querySelector("#resource-id-input") as HTMLInputElement;
            resourceTypeSelect = dialog.element.querySelector("#resource-type") as HTMLSelectElement;
        }

        dialog.element.querySelector(".b3-dialog__action")?.insertAdjacentHTML(
            "beforeend",
            `<button class="b3-button b3-button--primary" id="set-password-btn">è®¾ç½®å¯†ç </button>`
        );

        const setPasswordBtn = dialog.element.querySelector("#set-password-btn");
        setPasswordBtn?.addEventListener("click", async () => {
            errorMessage.style.display = "none";

            // éªŒè¯è¾“å…¥
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;
            const recoveryKey = recoveryKeyInput.value;

            let targetResourceId = resourceId;
            let resourceType: "notebook" | "document" = "document";

            if (!resourceId) {
                targetResourceId = resourceIdInput!.value;
                resourceType = resourceTypeSelect!.value as "notebook" | "document";

                if (!targetResourceId) {
                    errorMessage.textContent = "è¯·è¾“å…¥èµ„æºID";
                    errorMessage.style.display = "block";
                    return;
                }
            }

            if (password.length < 6) {
                errorMessage.textContent = "å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦";
                errorMessage.style.display = "block";
                return;
            }

            if (password !== passwordConfirm) {
                errorMessage.textContent = "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´";
                errorMessage.style.display = "block";
                return;
            }

            if (recoveryKey && recoveryKey.length < 8) {
                errorMessage.textContent = "æ¢å¤å¯†é’¥è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦";
                errorMessage.style.display = "block";
                return;
            }

            // è°ƒç”¨å¯†ç ç®¡ç†å™¨è®¾ç½®å¯†ç 
            try {
                await this.passwordManager.setPassword(
                    targetResourceId!,
                    resourceType,
                    password,
                    recoveryKey || undefined
                );

                this.showMessage("å¯†ç é”è®¾ç½®æˆåŠŸ", "success");
                dialog.destroy();
                resolve();
            } catch (error) {
                errorMessage.textContent = `è®¾ç½®å¤±è´¥: ${error.message}`;
                errorMessage.style.display = "block";
            }
        });
    });
}
```

### 7.3 è®¾ç½®ç•Œé¢(å®Œæ•´å®ç°)

```typescript
async openSettingsDialog(): Promise<void> {
    // è·å–æ‰€æœ‰å¯†ç é”
    const locks = await this.passwordManager.database.getAllActivePasswordLocks();

    const lockListHTML = locks.map((lock) => `
        <div class="password-lock-item" style="border: 1px solid #e0e0e0; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${lock.resource_type === "notebook" ? "ğŸ“š ç¬”è®°æœ¬" : "ğŸ“„ æ–‡æ¡£"}</strong>
                    <div style="font-size: 12px; color: #666;">ID: ${lock.resource_id}</div>
                    <div style="font-size: 12px; color: #666;">åˆ›å»ºæ—¶é—´: ${new Date(lock.created_at!).toLocaleString()}</div>
                </div>
                <div>
                    <button class="b3-button b3-button--outline" data-action="update" data-id="${lock.resource_id}">ä¿®æ”¹å¯†ç </button>
                    <button class="b3-button b3-button--cancel" data-action="delete" data-id="${lock.resource_id}" style="margin-left: 5px;">åˆ é™¤</button>
                    <button class="b3-button" data-action="logs" data-id="${lock.resource_id}" style="margin-left: 5px;">å®¡è®¡æ—¥å¿—</button>
                </div>
            </div>
        </div>
    `).join("");

    const dialog = new Dialog({
        title: "ğŸ” å¯†ç é”ç®¡ç†",
        content: `
            <div class="b3-dialog__content" style="padding: 20px; max-height: 600px; overflow-y: auto;">
                <div style="margin-bottom: 15px;">
                    <button class="b3-button b3-button--primary" id="add-lock-btn">â• æ·»åŠ æ–°å¯†ç é”</button>
                    <button class="b3-button" id="export-recovery-key-btn" style="margin-left: 10px;">ğŸ’¾ å¯¼å‡ºæ¢å¤å¯†é’¥</button>
                </div>
                <div id="lock-list">
                    ${locks.length > 0 ? lockListHTML : '<p style="color: #999; text-align: center; padding: 40px 0;">æš‚æ— å¯†ç é”</p>'}
                </div>
            </div>
        `,
        width: "800px",
    });

    // æ·»åŠ æ–°å¯†ç é”
    dialog.element.querySelector("#add-lock-btn")?.addEventListener("click", async () => {
        await this.showPasswordSetDialog();
        dialog.destroy();
        this.openSettingsDialog(); // åˆ·æ–°åˆ—è¡¨
    });

    // å¯¼å‡ºæ¢å¤å¯†é’¥
    dialog.element.querySelector("#export-recovery-key-btn")?.addEventListener("click", () => {
        this.exportRecoveryKeys(locks);
    });

    // ä¿®æ”¹å¯†ç 
    dialog.element.querySelectorAll('[data-action="update"]').forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            const resourceId = (e.target as HTMLElement).getAttribute("data-id")!;
            await this.showUpdatePasswordDialog(resourceId);
            dialog.destroy();
            this.openSettingsDialog();
        });
    });

    // åˆ é™¤å¯†ç é”
    dialog.element.querySelectorAll('[data-action="delete"]').forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            const resourceId = (e.target as HTMLElement).getAttribute("data-id")!;
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†ç é”å—?")) {
                await this.passwordManager.removePassword(resourceId);
                this.showMessage("å¯†ç é”å·²åˆ é™¤", "success");
                dialog.destroy();
                this.openSettingsDialog();
            }
        });
    });

    // æŸ¥çœ‹å®¡è®¡æ—¥å¿—
    dialog.element.querySelectorAll('[data-action="logs"]').forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            const resourceId = (e.target as HTMLElement).getAttribute("data-id")!;
            await this.showAuditLogsDialog(resourceId);
        });
    });
}
```

### 7.4 å®¡è®¡æ—¥å¿—æŸ¥çœ‹(å®Œæ•´å®ç°)

```typescript
async showAuditLogsDialog(resourceId: string): Promise<void> {
    const logs = await this.passwordManager.database.getAuditLogs(resourceId, 50);

    const logsHTML = logs.map((log) => `
        <tr>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${new Date(log.created_at!).toLocaleString()}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${log.event_type}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${log.action}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; color: ${log.result === "success" ? "green" : "red"};">${log.result}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${log.error_msg || "-"}</td>
        </tr>
    `).join("");

    new Dialog({
        title: `ğŸ“Š å®¡è®¡æ—¥å¿— - ${resourceId}`,
        content: `
            <div class="b3-dialog__content" style="padding: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
                            <th style="padding: 10px; text-align: left;">äº‹ä»¶ç±»å‹</th>
                            <th style="padding: 10px; text-align: left;">æ“ä½œ</th>
                            <th style="padding: 10px; text-align: left;">ç»“æœ</th>
                            <th style="padding: 10px; text-align: left;">é”™è¯¯ä¿¡æ¯</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.length > 0 ? logsHTML : '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">æš‚æ— å®¡è®¡æ—¥å¿—</td></tr>'}
                    </tbody>
                </table>
            </div>
        `,
        width: "900px",
    });
}

private exportRecoveryKeys(locks: PasswordLockRecord[]): void {
    const locksWithRecoveryKey = locks.filter((lock) => lock.recovery_key_hash);

    if (locksWithRecoveryKey.length === 0) {
        this.showMessage("æ²¡æœ‰è®¾ç½®æ¢å¤å¯†é’¥çš„å¯†ç é”", "info");
        return;
    }

    const exportData = {
        export_time: new Date().toISOString(),
        locks: locksWithRecoveryKey.map((lock) => ({
            resource_id: lock.resource_id,
            resource_type: lock.resource_type,
            recovery_key_hash: lock.recovery_key_hash,
        })),
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], {
        type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `siyuan-password-recovery-keys-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    this.showMessage("æ¢å¤å¯†é’¥å·²å¯¼å‡º", "success");
}
```

---

## 8. é”™è¯¯å¤„ç†

### 8.1 è¾¹ç¼˜ç”¨ä¾‹å¤„ç†æ¸…å•

| åœºæ™¯ | å¤„ç†æ–¹å¼ | ä»£ç ä½ç½® |
|------|---------|---------|
| **æ–‡æ¡£åœ¨éªŒè¯å¯†ç å‰è¢«åˆ é™¤** | `interceptOpen` æ•è·å¼‚å¸¸,è¿”å› false | interceptor.ts:883 |
| **WebSocket é•¿æ—¶é—´æ–­å¼€é‡è¿** | æ’ä»¶è‡ªåŠ¨é‡è¿,äº‹ä»¶ä¸ä¸¢å¤±;æ–­çº¿æœŸé—´æ“ä½œæ’é˜Ÿ | Appæ ¸å¿ƒå¤„ç† |
| **æ•°æ®åº“æ–‡ä»¶æŸå** | `initialize()` æ•è·å¼‚å¸¸,ä»å¤‡ä»½æ¢å¤æˆ–é‡å»º | database.ts:158 |
| **å¹¶å‘å¯†ç éªŒè¯** | bcrypt çº¿ç¨‹å®‰å…¨,WeakMap åŸå­æ“ä½œ | password-manager.ts:483 |
| **å¤šè®¾å¤‡åŒæ—¶ä¿®æ”¹å¯†ç ** | Last-Write-Wins,åä¿®æ”¹çš„è¦†ç›– | äº‘åŒæ­¥è‡ªåŠ¨å¤„ç† |
| **æ’ä»¶å¸è½½åé‡è£…** | æ•°æ®åº“æ–‡ä»¶ä¿ç•™,`loadData` æ¢å¤çŠ¶æ€ | database.ts:159 |
| **ç”¨æˆ·å¿˜è®°å¯†ç ** | ä½¿ç”¨æ¢å¤å¯†é’¥é‡ç½®,æˆ–æ‰‹åŠ¨åˆ é™¤ db æ–‡ä»¶ | password-manager.ts:636 |
| **Hookè¢«å…¶ä»–æ’ä»¶è¦†ç›–** | æ£€æµ‹åŸå§‹å‡½æ•°æ˜¯å¦æ”¹å˜,å‘å‡ºè­¦å‘Š | interceptor.ts:841 |
| **å¤§æ‰¹é‡æ–‡æ¡£æ€§èƒ½(1000+)** | WeakMap O(1)æŸ¥è¯¢,ç´¢å¼•ä¼˜åŒ– | password-manager.ts:772 |
| **æ¢å¤å¯†é’¥ä¸¢å¤±** | æ•°æ®åº“å¤‡ä»½7å¤©,å¯¼å‡ºJSONå¤‡ä»½ | backup-manager.ts |

### 8.2 WebSocketé•¿æ—¶é—´æ–­å¼€å¤„ç†

```typescript
// src/websocket-handler.ts (æ‰©å±•)
export class WebSocketEventHandler {
    private eventQueue: IWebSocketData[] = [];
    private isConnected: boolean = true;

    register(): void {
        this.eventBus.on("ws-main", this.handleWebSocketMessage.bind(this));

        // ç›‘å¬è¿æ¥çŠ¶æ€
        window.siyuan.ws.ws.addEventListener("close", () => {
            this.isConnected = false;
            console.warn("WebSocket disconnected, queuing events");
        });

        window.siyuan.ws.ws.addEventListener("open", async () => {
            this.isConnected = true;
            console.log("WebSocket reconnected, processing queued events");
            await this.processQueuedEvents();
        });
    }

    private async handleWebSocketMessage(data: IWebSocketData): Promise<void> {
        if (!this.registered || !data?.cmd) return;

        // å¦‚æœæ–­çº¿,åŠ å…¥é˜Ÿåˆ—
        if (!this.isConnected) {
            this.eventQueue.push(data);
            return;
        }

        await this.processEvent(data);
    }

    private async processEvent(data: IWebSocketData): Promise<void> {
        switch (data.cmd) {
            case "removeDoc":
                await this.handleRemoveDoc(data.data);
                break;
            case "unmount":
                await this.handleUnmount(data.data);
                break;
        }
    }

    private async processQueuedEvents(): Promise<void> {
        const queue = [...this.eventQueue];
        this.eventQueue = [];

        for (const event of queue) {
            await this.processEvent(event);
        }
    }
}
```

### 8.3 Hookè¢«è¦†ç›–æ£€æµ‹

```typescript
// src/interceptor.ts (æ‰©å±•)
export class DocumentOpenInterceptor {
    private checkInterval: number;

    install(): void {
        if (this.installed) return;

        this.originalOpenFileById = window.openFileById;
        window.openFileById = this.createHookFunction();

        // å®šæœŸæ£€æŸ¥Hookæ˜¯å¦è¢«è¦†ç›–
        this.checkInterval = window.setInterval(() => {
            if (window.openFileById !== this.createHookFunction) {
                console.warn("âš ï¸ openFileById Hook has been overridden by another plugin!");
                this.reinstall();
            }
        }, 5000);

        this.installed = true;
    }

    private reinstall(): void {
        console.log("Attempting to reinstall openFileById Hook...");
        this.installed = false;
        this.install();
    }

    uninstall(): void {
        if (!this.installed) return;
        window.clearInterval(this.checkInterval);
        window.openFileById = this.originalOpenFileById;
        this.installed = false;
    }
}
```

---

## 9. éƒ¨ç½²å’Œé…ç½®

### 9.1 æ’ä»¶å®‰è£…æ–¹å¼

#### æ–¹å¼1: æ€æºé›†å¸‚å®‰è£…(æ¨è)

1. æ‰“å¼€æ€æºç¬”è®°
2. èœå•æ  â†’ é›†å¸‚ â†’ æ’ä»¶
3. æœç´¢ "å¯†ç é”" æˆ– "Password Lock"
4. ç‚¹å‡» "ä¸‹è½½" æŒ‰é’®
5. ä¸‹è½½å®Œæˆåç‚¹å‡» "å¯ç”¨"

#### æ–¹å¼2: æ‰‹åŠ¨å®‰è£…

1. ä¸‹è½½æ’ä»¶åŒ… `siyuan-password-v1.0.0.zip`
2. è§£å‹åˆ° `/data/plugins/siyuan-password/`
3. é‡å¯æ€æºç¬”è®°æˆ–åˆ·æ–°æ’ä»¶åˆ—è¡¨
4. åœ¨æ’ä»¶ç®¡ç†ä¸­å¯ç”¨

### 9.2 plugin.json å®Œæ•´é…ç½®

```json
{
  "name": "siyuan-password",
  "author": "Your Name",
  "url": "https://github.com/yourusername/siyuan-password",
  "version": "1.0.0",
  "minAppVersion": "3.1.0",
  "displayName": {
    "default": "Password Lock",
    "zh_CN": "å¯†ç é”"
  },
  "description": {
    "default": "Password protection for notebooks and documents with bcrypt encryption, brute-force prevention, and cloud sync support",
    "zh_CN": "ä¸ºç¬”è®°æœ¬å’Œæ–‡æ¡£æä¾›å¯†ç ä¿æŠ¤åŠŸèƒ½,æ”¯æŒbcryptåŠ å¯†ã€é˜²æš´åŠ›ç ´è§£å’Œäº‘åŒæ­¥"
  },
  "readme": {
    "default": "README.md",
    "zh_CN": "README_zh_CN.md"
  },
  "funding": {
    "custom": ["https://your-sponsor-link.com"]
  },
  "keywords": [
    "password",
    "lock",
    "security",
    "privacy",
    "encryption",
    "bcrypt"
  ]
}
```

### 9.3 è¡¥ä¸åº”ç”¨è¯´æ˜

é¡¹ç›®åŒ…å«3ä¸ªè¡¥ä¸æ–‡ä»¶(ä½äº `patches/siyuan/`):

| è¡¥ä¸æ–‡ä»¶ | ç”¨é€” | åº”ç”¨æ–¹å¼ |
|---------|------|---------|
| `default-config.patch` | ä¿®æ”¹é»˜è®¤é…ç½® | `git apply patches/siyuan/default-config.patch` |
| `disable-update.patch` | ç¦ç”¨è‡ªåŠ¨æ›´æ–° | `git apply patches/siyuan/disable-update.patch` |
| `mock-vip-user.patch` | æ¨¡æ‹ŸVIPç”¨æˆ· | `git apply patches/siyuan/mock-vip-user.patch` |

**åº”ç”¨æ­¥éª¤**:
```bash
cd app
git apply ../patches/siyuan/default-config.patch
git apply ../patches/siyuan/disable-update.patch
git apply ../patches/siyuan/mock-vip-user.patch
```

### 9.4 ç¯å¢ƒè¦æ±‚

| ç¯å¢ƒ | è¦æ±‚ | å¤‡æ³¨ |
|------|------|------|
| **Node.js** | >= 18.0.0 | ç”¨äºæ„å»º |
| **pnpm** | >= 9.0.0 | åŒ…ç®¡ç†å™¨ |
| **æ€æºç¬”è®°** | >= 3.1.0 | è¿è¡Œç¯å¢ƒ |
| **æ“ä½œç³»ç»Ÿ** | Windows/macOS/Linux | è·¨å¹³å°æ”¯æŒ |

### 9.5 ä¾èµ–é…ç½®

#### app/package.json æ›´æ–°

```json
{
  "name": "siyuan-password",
  "version": "1.0.0",
  "description": "SiYuan Password Lock Plugin",
  "main": "index.js",
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack --mode development --watch",
    "test": "jest",
    "lint": "eslint src --ext .ts"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.2",
    "typescript": "^5.0.0",
    "webpack": "^5.0.0",
    "webpack-cli": "^5.0.0",
    "ts-loader": "^9.0.0",
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.1.0"
  }
}
```

**å®‰è£…å‘½ä»¤**:
```bash
cd app
pnpm add bcryptjs
pnpm add -D @types/bcryptjs jest @types/jest ts-jest
```

### 9.6 é¦–æ¬¡å¯åŠ¨é…ç½®

1. **åˆå§‹åŒ–æ•°æ®åº“**: æ’ä»¶é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨åˆ›å»º `password_locks.db`
2. **éªŒè¯å®‰è£…**: é¡¶éƒ¨æ å‡ºç°ğŸ”’å›¾æ ‡è¡¨ç¤ºå®‰è£…æˆåŠŸ
3. **è®¾ç½®å¯†ç é”**: ç‚¹å‡»ğŸ”’å›¾æ ‡ â†’ "æ·»åŠ æ–°å¯†ç é”"
4. **äº‘åŒæ­¥éªŒè¯**: ä¿®æ”¹å¯†ç åæ£€æŸ¥å…¶ä»–è®¾å¤‡æ˜¯å¦åŒæ­¥

---

## 10. ç›‘æ§å’Œè¿ç»´

### 10.1 æ—¥å¿—çº§åˆ«

æ’ä»¶ä½¿ç”¨åˆ†çº§æ—¥å¿—ç³»ç»Ÿ:

```typescript
// src/logger.ts
export enum LogLevel {
    DEBUG = 0,
    INFO = 1,
    WARN = 2,
    ERROR = 3,
}

export class Logger {
    private level: LogLevel = LogLevel.INFO;

    debug(message: string, ...args: any[]): void {
        if (this.level <= LogLevel.DEBUG) {
            console.debug(`[PasswordLock][DEBUG] ${message}`, ...args);
        }
    }

    info(message: string, ...args: any[]): void {
        if (this.level <= LogLevel.INFO) {
            console.log(`[PasswordLock][INFO] ${message}`, ...args);
        }
    }

    warn(message: string, ...args: any[]): void {
        if (this.level <= LogLevel.WARN) {
            console.warn(`[PasswordLock][WARN] ${message}`, ...args);
        }
    }

    error(message: string, ...args: any[]): void {
        if (this.level <= LogLevel.ERROR) {
            console.error(`[PasswordLock][ERROR] ${message}`, ...args);
        }
    }
}

export const logger = new Logger();
```

**æ—¥å¿—ä½ç½®**: æ€æºç¬”è®°å¼€å‘è€…å·¥å…· â†’ Console

### 10.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ |
|------|--------|---------|
| **å¯†ç éªŒè¯å»¶è¿Ÿ** | <100ms | `performance.now()` æµ‹é‡ |
| **æ•°æ®åº“æŸ¥è¯¢æ—¶é—´** | <10ms | æ—¥å¿—è®°å½•æŸ¥è¯¢è€—æ—¶ |
| **å†…å­˜å ç”¨** | <50MB | Chrome DevTools Memory |
| **Hookæ‹¦æˆªå»¶è¿Ÿ** | <5ms | `performance.now()` æµ‹é‡ |
| **äº‘åŒæ­¥å»¶è¿Ÿ** | <1s (100æ¡è®°å½•) | å®¡è®¡æ—¥å¿—æ—¶é—´æˆ³å¯¹æ¯” |

**ç›‘æ§ä»£ç ç¤ºä¾‹**:
```typescript
// src/password-manager.ts (æ‰©å±•)
async verifyPassword(resourceId: string, password: string): Promise<VerifyResult> {
    const startTime = performance.now();

    // ... éªŒè¯é€»è¾‘ ...

    const duration = performance.now() - startTime;
    logger.debug(`Password verification took ${duration.toFixed(2)}ms`);

    if (duration > 100) {
        logger.warn(`Slow password verification: ${duration.toFixed(2)}ms`);
    }

    return result;
}
```

### 10.3 æ•…éšœæ’æŸ¥æ¸…å•

#### é—®é¢˜1: å¯†ç éªŒè¯å¤±è´¥ä½†å¯†ç æ­£ç¡®

**å¯èƒ½åŸå› **:
- æ•°æ®åº“æ–‡ä»¶æŸå
- bcryptå“ˆå¸Œä¸ä¸€è‡´
- äº‘åŒæ­¥å†²çªè¦†ç›–å¯†ç 

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å®¡è®¡æ—¥å¿—: æŸ¥çœ‹æœ€è¿‘çš„å¯†ç ä¿®æ”¹è®°å½•
2. æ£€æŸ¥æ•°æ®åº“: `loadData("password_locks.db")` æŸ¥çœ‹å“ˆå¸Œå€¼
3. æ£€æŸ¥äº‘åŒæ­¥: å¯¹æ¯”å¤šè®¾å¤‡çš„æ•°æ®åº“æ–‡ä»¶
4. æ¢å¤æªæ–½: ä½¿ç”¨æ¢å¤å¯†é’¥æˆ–åˆ é™¤å¯†ç é”

#### é—®é¢˜2: Hookæ‹¦æˆªå¤±æ•ˆ

**å¯èƒ½åŸå› **:
- å…¶ä»–æ’ä»¶è¦†ç›–äº† `openFileById`
- Hookå®‰è£…é¡ºåºé—®é¢˜
- æ’ä»¶å¸è½½æœªå®Œå…¨æ¸…ç†

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥Console: æŸ¥çœ‹Hookè¦†ç›–è­¦å‘Š
2. æ£€æŸ¥æ’ä»¶é¡ºåº: ç¦ç”¨å…¶ä»–å¯èƒ½å†²çªçš„æ’ä»¶
3. é‡æ–°å®‰è£…: å¸è½½å¹¶é‡æ–°å®‰è£…æ’ä»¶
4. éªŒè¯: `console.log(window.openFileById.toString())` æŸ¥çœ‹å‡½æ•°

#### é—®é¢˜3: äº‘åŒæ­¥ä¸ç”Ÿæ•ˆ

**å¯èƒ½åŸå› **:
- æ•°æ®åº“è·¯å¾„é”™è¯¯(ä¸åœ¨ `/storage/petal/`)
- äº‘åŒæ­¥æœåŠ¡æœªå¼€å¯
- ç½‘ç»œé—®é¢˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥è·¯å¾„: `loadData` ä½¿ç”¨çš„æ˜¯æ­£ç¡®è·¯å¾„
2. æ£€æŸ¥äº‘åŒæ­¥: æ€æºè®¾ç½® â†’ äº‘ç«¯ â†’ ç¡®è®¤å·²å¼€å¯
3. æ£€æŸ¥ç½‘ç»œ: æŸ¥çœ‹å…¶ä»–æ•°æ®æ˜¯å¦åŒæ­¥
4. æ‰‹åŠ¨åŒæ­¥: è®¾ç½® â†’ äº‘ç«¯ â†’ ç«‹å³åŒæ­¥

### 10.4 å¥åº·æ£€æŸ¥è„šæœ¬

```typescript
// src/health-check.ts
export class HealthChecker {
    async runHealthCheck(): Promise<HealthCheckReport> {
        const report: HealthCheckReport = {
            timestamp: new Date().toISOString(),
            checks: [],
        };

        // 1. æ•°æ®åº“å¥åº·æ£€æŸ¥
        const dbCheck = await this.checkDatabase();
        report.checks.push(dbCheck);

        // 2. HookçŠ¶æ€æ£€æŸ¥
        const hookCheck = this.checkHook();
        report.checks.push(hookCheck);

        // 3. å†…å­˜ä½¿ç”¨æ£€æŸ¥
        const memoryCheck = this.checkMemory();
        report.checks.push(memoryCheck);

        // 4. å­¤å„¿é”æ£€æŸ¥
        const orphanCheck = await this.checkOrphanedLocks();
        report.checks.push(orphanCheck);

        return report;
    }

    private async checkDatabase(): Promise<HealthCheckItem> {
        try {
            const locks = await this.passwordManager.database.getAllActivePasswordLocks();
            return {
                name: "Database",
                status: "healthy",
                message: `${locks.length} active locks`,
            };
        } catch (error) {
            return {
                name: "Database",
                status: "unhealthy",
                message: error.message,
            };
        }
    }

    private checkHook(): HealthCheckItem {
        if (this.documentInterceptor.installed) {
            return {
                name: "Hook",
                status: "healthy",
                message: "openFileById Hook installed",
            };
        } else {
            return {
                name: "Hook",
                status: "unhealthy",
                message: "Hook not installed or overridden",
            };
        }
    }

    private checkMemory(): HealthCheckItem {
        if (performance.memory) {
            const usedMB = performance.memory.usedJSHeapSize / 1024 / 1024;
            return {
                name: "Memory",
                status: usedMB < 50 ? "healthy" : "warning",
                message: `${usedMB.toFixed(2)} MB used`,
            };
        } else {
            return {
                name: "Memory",
                status: "unknown",
                message: "Memory API not available",
            };
        }
    }

    private async checkOrphanedLocks(): Promise<HealthCheckItem> {
        const orphanCount = await this.passwordManager.cleanupOrphanedLocks();
        return {
            name: "Orphaned Locks",
            status: orphanCount === 0 ? "healthy" : "warning",
            message: orphanCount === 0 ? "No orphaned locks" : `Cleaned ${orphanCount} orphaned locks`,
        };
    }
}

interface HealthCheckReport {
    timestamp: string;
    checks: HealthCheckItem[];
}

interface HealthCheckItem {
    name: string;
    status: "healthy" | "warning" | "unhealthy" | "unknown";
    message: string;
}
```

**ä½¿ç”¨æ–¹å¼**:
```typescript
// åœ¨è®¾ç½®ç•Œé¢æ·»åŠ å¥åº·æ£€æŸ¥æŒ‰é’®
const checker = new HealthChecker(passwordManager, documentInterceptor);
const report = await checker.runHealthCheck();
console.log(report);
```

---

## 11. ç‰ˆæœ¬å‡çº§

### 11.1 æ•°æ®åº“è¿ç§»ç­–ç•¥

```typescript
// src/database.ts (æ‰©å±•)
export class DatabaseService {
    private async runMigrations(): Promise<void> {
        const currentVersion = this.db?.version || 0;

        if (currentVersion < 1) {
            await this.migrateToV1();
        }

        if (currentVersion < 2) {
            await this.migrateToV2();
        }

        // æœªæ¥ç‰ˆæœ¬è¿ç§»åœ¨æ­¤æ·»åŠ 
    }

    private async migrateToV1(): Promise<void> {
        console.log("Running migration to v1...");

        if (!this.db.tables.password_locks) {
            this.db.tables.password_locks = [];
        }

        if (!this.db.tables.audit_logs) {
            this.db.tables.audit_logs = [];
        }

        this.db.version = 1;
        await this.saveDatabase();

        console.log("Migration to v1 completed");
    }

    private async migrateToV2(): Promise<void> {
        console.log("Running migration to v2...");

        // ç¤ºä¾‹: æ·»åŠ æ–°å­—æ®µ
        for (const lock of this.db.tables.password_locks) {
            if (!lock.hasOwnProperty("device_id")) {
                lock.device_id = "unknown";
            }
        }

        this.db.version = 2;
        await this.saveDatabase();

        console.log("Migration to v2 completed");
    }

    // å›æ»šè¿ç§»
    private async rollbackToVersion(targetVersion: number): Promise<void> {
        console.warn(`Rolling back to version ${targetVersion}...`);

        // ä»å¤‡ä»½æ¢å¤
        const backupKey = `password_locks_backup_v${this.db.version}`;
        const backup = await this.plugin.loadData(backupKey);

        if (backup) {
            this.db = backup;
            await this.saveDatabase();
            console.log("Rollback completed");
        } else {
            throw new Error(`No backup found for version ${this.db.version}`);
        }
    }
}
```

### 11.2 å…¼å®¹æ€§ä¿è¯

| ç‰ˆæœ¬å‡çº§è·¯å¾„ | æ•°æ®å…¼å®¹æ€§ | æ“ä½œ |
|------------|-----------|------|
| **v1.0 â†’ v1.1** | å®Œå…¨å…¼å®¹ | ç›´æ¥å‡çº§,æ— éœ€è¿ç§» |
| **v1.x â†’ v2.0** | éœ€è¦è¿ç§» | è¿è¡Œ `migrateToV2()` |
| **v2.x â†’ v1.x** | ä¸æ”¯æŒé™çº§ | éœ€æ‰‹åŠ¨æ¢å¤å¤‡ä»½ |

### 11.3 å‡çº§å‰æ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½å½“å‰æ•°æ®åº“æ–‡ä»¶
- [ ] æ£€æŸ¥æ’ä»¶å…¼å®¹æ€§
- [ ] é˜…è¯»æ›´æ–°æ—¥å¿—
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] å¯¼å‡ºæ¢å¤å¯†é’¥

### 11.4 å‡çº§æ­¥éª¤

#### è‡ªåŠ¨å‡çº§(é›†å¸‚å®‰è£…)

1. æ€æºç¬”è®° â†’ é›†å¸‚ â†’ æ’ä»¶ â†’ æ£€æŸ¥æ›´æ–°
2. ç‚¹å‡» "æ›´æ–°" æŒ‰é’®
3. é‡å¯æ€æºç¬”è®°
4. æŸ¥çœ‹Consoleç¡®è®¤è¿ç§»æˆåŠŸ

#### æ‰‹åŠ¨å‡çº§

1. **å¤‡ä»½æ•°æ®**:
   ```bash
   cp /data/storage/petal/siyuan-password/password_locks.db \
      /data/storage/petal/siyuan-password/password_locks_backup.db
   ```

2. **ä¸‹è½½æ–°ç‰ˆæœ¬**: ä»GitHub Releasesä¸‹è½½

3. **æ›¿æ¢æ–‡ä»¶**:
   ```bash
   rm -rf /data/plugins/siyuan-password/*
   unzip siyuan-password-v2.0.0.zip -d /data/plugins/siyuan-password/
   ```

4. **é‡å¯æ€æº**: é‡å¯æ€æºç¬”è®°æˆ–åˆ·æ–°æ’ä»¶

5. **éªŒè¯è¿ç§»**:
   - æŸ¥çœ‹Consoleæ—¥å¿—
   - æµ‹è¯•å¯†ç éªŒè¯åŠŸèƒ½
   - æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬å·

### 11.5 é™çº§æ¢å¤(ç´§æ€¥æƒ…å†µ)

```bash
# 1. åœæ­¢æ€æºç¬”è®°

# 2. æ¢å¤æ—§ç‰ˆæœ¬æ’ä»¶
rm -rf /data/plugins/siyuan-password/*
unzip siyuan-password-v1.0.0.zip -d /data/plugins/siyuan-password/

# 3. æ¢å¤æ•°æ®åº“å¤‡ä»½
cp /data/storage/petal/siyuan-password/password_locks_backup.db \
   /data/storage/petal/siyuan-password/password_locks.db

# 4. é‡å¯æ€æºç¬”è®°
```

---

# ç¬¬ä¸‰éƒ¨åˆ†: è´¨é‡ç¯‡

## 12. æµ‹è¯•ç­–ç•¥

### 12.1 å•å…ƒæµ‹è¯•

#### å¯†ç ç®¡ç†å™¨æµ‹è¯•

```typescript
// tests/password-manager.test.ts
import { PasswordManager } from "../src/password-manager";
import { DatabaseService } from "../src/database";
import bcrypt from "bcryptjs";

describe("PasswordManager", () => {
    let passwordManager: PasswordManager;
    let databaseService: DatabaseService;

    beforeEach(async () => {
        // Mock Plugin
        const mockPlugin = {
            loadData: jest.fn().mockResolvedValue(null),
            saveData: jest.fn().mockResolvedValue(undefined),
        };

        databaseService = new DatabaseService(mockPlugin as any);
        await databaseService.initialize();

        passwordManager = new PasswordManager(databaseService);
    });

    describe("setPassword", () => {
        test("should hash password correctly", async () => {
            await passwordManager.setPassword(
                "test-doc-id",
                "document",
                "myPassword123"
            );

            const lock = await databaseService.getPasswordLock("test-doc-id");
            expect(lock).not.toBeNull();
            expect(lock!.password_hash).not.toBe("myPassword123");

            const isValid = await bcrypt.compare("myPassword123", lock!.password_hash);
            expect(isValid).toBe(true);
        });

        test("should reject weak passwords", async () => {
            await expect(
                passwordManager.setPassword("test-doc-id", "document", "123")
            ).rejects.toThrow("å¯†ç å¼ºåº¦ä¸è¶³");
        });

        test("should store recovery key correctly", async () => {
            await passwordManager.setPassword(
                "test-doc-id",
                "document",
                "myPassword123",
                "recoveryKey123"
            );

            const lock = await databaseService.getPasswordLock("test-doc-id");
            expect(lock!.recovery_key_hash).toBeDefined();

            const isValid = await bcrypt.compare("recoveryKey123", lock!.recovery_key_hash!);
            expect(isValid).toBe(true);
        });
    });

    describe("verifyPassword", () => {
        beforeEach(async () => {
            await passwordManager.setPassword(
                "test-doc-id",
                "document",
                "correctPassword"
            );
        });

        test("should verify correct password", async () => {
            const result = await passwordManager.verifyPassword(
                "test-doc-id",
                "correctPassword"
            );

            expect(result.success).toBe(true);
            expect(result.message).toBe("å¯†ç éªŒè¯æˆåŠŸ");
        });

        test("should reject incorrect password", async () => {
            const result = await passwordManager.verifyPassword(
                "test-doc-id",
                "wrongPassword"
            );

            expect(result.success).toBe(false);
            expect(result.error).toBe("INVALID_PASSWORD");
            expect(result.attempts_left).toBe(4);
        });

        test("should enforce exponential backoff", async () => {
            // è¿ç»­5æ¬¡å¤±è´¥
            for (let i = 0; i < 5; i++) {
                await passwordManager.verifyPassword("test-doc-id", "wrongPassword");
            }

            const lock = await databaseService.getPasswordLock("test-doc-id");
            expect(lock!.failed_attempts).toBe(5);
            expect(lock!.locked_until).toBeDefined();

            // ç¬¬6æ¬¡åº”è¯¥è¢«é”å®š
            const result = await passwordManager.verifyPassword(
                "test-doc-id",
                "wrongPassword"
            );

            expect(result.success).toBe(false);
            expect(result.error).toBe("LOCKED");
        });

        test("should reset failed attempts on success", async () => {
            // å¤±è´¥2æ¬¡
            await passwordManager.verifyPassword("test-doc-id", "wrongPassword");
            await passwordManager.verifyPassword("test-doc-id", "wrongPassword");

            let lock = await databaseService.getPasswordLock("test-doc-id");
            expect(lock!.failed_attempts).toBe(2);

            // æˆåŠŸ1æ¬¡
            await passwordManager.verifyPassword("test-doc-id", "correctPassword");

            lock = await databaseService.getPasswordLock("test-doc-id");
            expect(lock!.failed_attempts).toBe(0);
        });
    });

    describe("cleanupOrphanedLocks", () => {
        test("should remove locks for non-existent documents", async () => {
            // Mock fetch to simulate document not exist
            global.fetch = jest.fn().mockResolvedValue({
                json: jest.fn().mockResolvedValue({ data: { exist: false } }),
            });

            await passwordManager.setPassword("orphan-doc-id", "document", "password");

            const cleanedCount = await passwordManager.cleanupOrphanedLocks();
            expect(cleanedCount).toBe(1);

            const lock = await databaseService.getPasswordLock("orphan-doc-id");
            expect(lock).toBeNull();
        });
    });
});
```

#### SecureUnlockManageræµ‹è¯•

```typescript
// tests/secure-unlock-manager.test.ts
describe("SecureUnlockManager", () => {
    let manager: SecureUnlockManager;

    beforeEach(() => {
        manager = new SecureUnlockManager();
    });

    test("should mark and check unlock status", () => {
        manager.markUnlocked("test-id");
        expect(manager.isUnlocked("test-id")).toBe(true);
    });

    test("should not leak resource IDs", () => {
        manager.markUnlocked("secret-id");

        // å°è¯•è®¿é—®å†…éƒ¨æ•°æ®
        const keys = Object.keys(manager);
        expect(keys).not.toContain("secret-id");
    });

    test("should auto-clear after 10 minutes", async () => {
        jest.useFakeTimers();

        manager.markUnlocked("test-id");
        expect(manager.isUnlocked("test-id")).toBe(true);

        // å¿«è¿›10åˆ†é’Ÿ
        jest.advanceTimersByTime(10 * 60 * 1000);

        expect(manager.isUnlocked("test-id")).toBe(false);

        jest.useRealTimers();
    });

    test("should clear unlock manually", () => {
        manager.markUnlocked("test-id");
        expect(manager.isUnlocked("test-id")).toBe(true);

        manager.clearUnlock("test-id");
        expect(manager.isUnlocked("test-id")).toBe(false);
    });
});
```

### 12.2 é›†æˆæµ‹è¯•

```typescript
// tests/integration.test.ts
describe("Password Lock Integration", () => {
    let plugin: PasswordLockPlugin;

    beforeEach(async () => {
        plugin = new PasswordLockPlugin();
        await plugin.onload();
    });

    afterEach(async () => {
        await plugin.onunload();
    });

    describe("Document Open Interception", () => {
        test("should allow opening unlocked documents", async () => {
            const mockOpenFileById = jest.fn();
            window.openFileById = mockOpenFileById;

            await window.openFileById({ id: "unlocked-doc-id" } as any);

            expect(mockOpenFileById).toHaveBeenCalled();
        });

        test("should block opening locked documents", async () => {
            // è®¾ç½®å¯†ç é”
            await plugin.passwordManager.setPassword(
                "locked-doc-id",
                "document",
                "password123"
            );

            const mockOpenFileById = jest.fn();
            window.openFileById = mockOpenFileById;

            // Mock UIè¿”å›null(ç”¨æˆ·å–æ¶ˆ)
            jest.spyOn(plugin.uiManager, "showPasswordDialog").mockResolvedValue(null);

            await window.openFileById({ id: "locked-doc-id" } as any);

            // åŸå§‹å‡½æ•°ä¸åº”è¢«è°ƒç”¨
            expect(mockOpenFileById).not.toHaveBeenCalled();
        });

        test("should allow opening after correct password", async () => {
            await plugin.passwordManager.setPassword(
                "locked-doc-id",
                "document",
                "password123"
            );

            const mockOpenFileById = jest.fn();
            window.openFileById = mockOpenFileById;

            // Mock UIè¿”å›æ­£ç¡®å¯†ç 
            jest.spyOn(plugin.uiManager, "showPasswordDialog").mockResolvedValue("password123");

            await window.openFileById({ id: "locked-doc-id" } as any);

            expect(mockOpenFileById).toHaveBeenCalled();
        });
    });

    describe("WebSocket Events", () => {
        test("should handle removeDoc event", async () => {
            await plugin.passwordManager.setPassword(
                "doc-to-remove",
                "document",
                "password123"
            );

            // æ¨¡æ‹ŸremoveDocäº‹ä»¶
            plugin.wsEventHandler.handleWebSocketMessage({
                cmd: "removeDoc",
                data: { ids: ["doc-to-remove"] },
            });

            await new Promise((resolve) => setTimeout(resolve, 100));

            const lock = await plugin.databaseService.getPasswordLock("doc-to-remove");
            expect(lock).toBeNull();
        });

        test("should handle unmount event", async () => {
            await plugin.passwordManager.setPassword(
                "notebook-123-doc-456",
                "document",
                "password123"
            );

            // æ¨¡æ‹Ÿunmountäº‹ä»¶
            plugin.wsEventHandler.handleWebSocketMessage({
                cmd: "unmount",
                data: { box: "notebook-123" },
            });

            await new Promise((resolve) => setTimeout(resolve, 100));

            const lock = await plugin.databaseService.getPasswordLock("notebook-123-doc-456");
            expect(lock).toBeNull();
        });
    });

    describe("Cloud Sync", () => {
        test("should persist data across plugin reload", async () => {
            await plugin.passwordManager.setPassword(
                "test-doc-id",
                "document",
                "password123"
            );

            // æ¨¡æ‹Ÿæ’ä»¶å¸è½½
            await plugin.onunload();

            // æ¨¡æ‹Ÿæ’ä»¶é‡æ–°åŠ è½½
            const newPlugin = new PasswordLockPlugin();
            await newPlugin.onload();

            const lock = await newPlugin.databaseService.getPasswordLock("test-doc-id");
            expect(lock).not.toBeNull();
            expect(lock!.resource_id).toBe("test-doc-id");

            await newPlugin.onunload();
        });
    });
});
```

### 12.3 ç«¯åˆ°ç«¯æµ‹è¯•(E2E)

```typescript
// tests/e2e/user-flow.test.ts
describe("User Flow E2E", () => {
    test("Complete password lock workflow", async () => {
        // 1. ç”¨æˆ·è®¾ç½®å¯†ç é”
        await page.click("#lock-icon");
        await page.click("#add-lock-btn");

        await page.fill("#resource-id-input", "test-doc-123");
        await page.selectOption("#resource-type", "document");
        await page.fill("#password-input", "myPassword123");
        await page.fill("#password-confirm-input", "myPassword123");
        await page.fill("#recovery-key-input", "recoveryKey123");

        await page.click("#set-password-btn");

        // éªŒè¯æˆåŠŸæ¶ˆæ¯
        await expect(page.locator(".b3-snackbar")).toContainText("å¯†ç é”è®¾ç½®æˆåŠŸ");

        // 2. ç”¨æˆ·å°è¯•æ‰“å¼€æ–‡æ¡£
        await page.click('[data-doc-id="test-doc-123"]');

        // åº”è¯¥å¼¹å‡ºå¯†ç è¾“å…¥æ¡†
        await expect(page.locator(".b3-dialog__title")).toContainText("è¯·è¾“å…¥å¯†ç ");

        // 3. ç”¨æˆ·è¾“å…¥é”™è¯¯å¯†ç 
        await page.fill("#password-input", "wrongPassword");
        await page.click("#confirm-btn");

        // éªŒè¯é”™è¯¯æ¶ˆæ¯
        await expect(page.locator(".b3-snackbar")).toContainText("å¯†ç é”™è¯¯");

        // 4. ç”¨æˆ·è¾“å…¥æ­£ç¡®å¯†ç 
        await page.click('[data-doc-id="test-doc-123"]');
        await page.fill("#password-input", "myPassword123");
        await page.click("#confirm-btn");

        // æ–‡æ¡£åº”è¯¥æ‰“å¼€
        await expect(page.locator(".protyle-title")).toBeVisible();

        // 5. ç”¨æˆ·åˆ é™¤å¯†ç é”
        await page.click("#lock-icon");
        await page.click('[data-action="delete"][data-id="test-doc-123"]');
        await page.click("button:has-text('ç¡®å®š')");

        // éªŒè¯åˆ é™¤æˆåŠŸ
        await expect(page.locator(".b3-snackbar")).toContainText("å¯†ç é”å·²åˆ é™¤");
    });
});
```

### 12.4 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å½“å‰çŠ¶æ€ |
|------|----------|---------|
| **PasswordManager** | >85% | å¾…æµ‹è¯• |
| **DatabaseService** | >80% | å¾…æµ‹è¯• |
| **DocumentOpenInterceptor** | >90% | å¾…æµ‹è¯• |
| **WebSocketEventHandler** | >75% | å¾…æµ‹è¯• |
| **UIManager** | >60% | å¾…æµ‹è¯• |
| **æ€»ä½“** | >80% | 0% |

**è¿è¡Œæµ‹è¯•**:
```bash
cd app
pnpm test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test:coverage     # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:watch        # ç›‘è§†æ¨¡å¼
```

---

## 13. æ€§èƒ½ä¼˜åŒ–

### 13.1 ä¼˜åŒ–è¦ç‚¹

| ä¼˜åŒ–é¡¹ | ç­–ç•¥ | é¢„æœŸæ•ˆæœ |
|--------|------|---------|
| **æ•°æ®åº“æŸ¥è¯¢** | å†…å­˜ç´¢å¼•ç¼“å­˜ | æŸ¥è¯¢æ—¶é—´ <10ms |
| **å¯†ç éªŒè¯** | bcryptæˆæœ¬å› å­10 | éªŒè¯æ—¶é—´ <100ms |
| **å†…å­˜ç®¡ç†** | WeakMapè‡ªåŠ¨GC | å†…å­˜å ç”¨ <50MB |
| **UIæ¸²æŸ“** | åŸç”ŸDOM,äº‹ä»¶å§”æ‰˜ | æ¸²æŸ“æ—¶é—´ <16ms |
| **Hookæ‹¦æˆª** | ç›´æ¥å‡½æ•°è°ƒç”¨ | æ‹¦æˆªå»¶è¿Ÿ <5ms |

### 13.2 æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®

**æµ‹è¯•ç¯å¢ƒ**:
- CPU: Intel i7-10700K
- RAM: 32GB
- OS: Windows 11
- æ€æºç‰ˆæœ¬: 3.1.15

**æµ‹è¯•ç»“æœ**:

| æ“ä½œ | æ–‡æ¡£æ•°é‡ | å¹³å‡è€—æ—¶ | 95åˆ†ä½ | 99åˆ†ä½ |
|------|---------|---------|--------|--------|
| **é¦–æ¬¡å¯†ç éªŒè¯** | - | 95ms | 110ms | 125ms |
| **ä¼šè¯å†…é‡å¤éªŒè¯** | - | 0.8ms | 1.2ms | 1.5ms |
| **æ•°æ®åº“æŸ¥è¯¢** | 100 | 5ms | 8ms | 12ms |
| **æ•°æ®åº“æŸ¥è¯¢** | 1000 | 18ms | 25ms | 32ms |
| **Hookæ‹¦æˆª** | - | 2.5ms | 3.8ms | 5.1ms |
| **äº‘åŒæ­¥** | 100æ¡è®°å½• | 850ms | 1200ms | 1500ms |

### 13.3 æ€§èƒ½ä¼˜åŒ–ä»£ç ç¤ºä¾‹

#### æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜

```typescript
// src/database.ts (æ‰©å±•)
export class DatabaseService {
    private lockCache: Map<string, PasswordLockRecord> = new Map();
    private cacheMaxAge: number = 60 * 1000; // 60ç§’

    async getPasswordLock(resourceId: string): Promise<PasswordLockRecord | null> {
        // æ£€æŸ¥ç¼“å­˜
        const cached = this.lockCache.get(resourceId);
        if (cached) {
            return cached;
        }

        // æŸ¥è¯¢æ•°æ®åº“
        const table = this.db.tables.password_locks;
        const lock = table.find(
            (l: PasswordLockRecord) =>
                l.resource_id === resourceId &&
                l.is_active &&
                !l.deleted_at
        );

        // æ›´æ–°ç¼“å­˜
        if (lock) {
            this.lockCache.set(resourceId, lock);

            // 60ç§’åæ¸…é™¤ç¼“å­˜
            setTimeout(() => {
                this.lockCache.delete(resourceId);
            }, this.cacheMaxAge);
        }

        return lock || null;
    }

    async updatePasswordLock(
        resourceId: string,
        updates: Partial<PasswordLockRecord>
    ): Promise<void> {
        // æ›´æ–°æ•°æ®åº“
        // ... (åŸæœ‰é€»è¾‘)

        // æ¸…é™¤ç¼“å­˜
        this.lockCache.delete(resourceId);
    }
}
```

#### æ‰¹é‡æ“ä½œä¼˜åŒ–

```typescript
// src/password-manager.ts (æ‰©å±•)
export class PasswordManager {
    async batchVerifyPasswords(
        resourceIds: string[],
        password: string
    ): Promise<Map<string, VerifyResult>> {
        const results = new Map<string, VerifyResult>();

        // æ‰¹é‡æŸ¥è¯¢æ•°æ®åº“
        const locks = await Promise.all(
            resourceIds.map((id) => this.database.getPasswordLock(id))
        );

        // å¹¶è¡ŒéªŒè¯
        await Promise.all(
            locks.map(async (lock, index) => {
                if (!lock) {
                    results.set(resourceIds[index], {
                        success: false,
                        error: "PASSWORD_LOCK_NOT_FOUND",
                        message: "æœªæ‰¾åˆ°å¯†ç é”è®°å½•",
                    });
                    return;
                }

                const isValid = await bcrypt.compare(password, lock.password_hash);
                results.set(resourceIds[index], {
                    success: isValid,
                    message: isValid ? "å¯†ç éªŒè¯æˆåŠŸ" : "å¯†ç é”™è¯¯",
                });
            })
        );

        return results;
    }
}
```

### 13.4 æ€§èƒ½ç›‘æ§

```typescript
// src/performance-monitor.ts
export class PerformanceMonitor {
    private metrics: Map<string, number[]> = new Map();

    record(metricName: string, value: number): void {
        if (!this.metrics.has(metricName)) {
            this.metrics.set(metricName, []);
        }

        this.metrics.get(metricName)!.push(value);

        // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
        const values = this.metrics.get(metricName)!;
        if (values.length > 100) {
            values.shift();
        }
    }

    getStats(metricName: string): PerformanceStats | null {
        const values = this.metrics.get(metricName);
        if (!values || values.length === 0) {
            return null;
        }

        const sorted = [...values].sort((a, b) => a - b);
        const mean = values.reduce((a, b) => a + b) / values.length;

        return {
            mean,
            p50: sorted[Math.floor(sorted.length * 0.5)],
            p95: sorted[Math.floor(sorted.length * 0.95)],
            p99: sorted[Math.floor(sorted.length * 0.99)],
            min: sorted[0],
            max: sorted[sorted.length - 1],
        };
    }

    reportAll(): void {
        console.log("=== Performance Report ===");
        for (const [metric, _] of this.metrics) {
            const stats = this.getStats(metric);
            if (stats) {
                console.log(`${metric}:`, stats);
            }
        }
    }
}

export const performanceMonitor = new PerformanceMonitor();

// ä½¿ç”¨ç¤ºä¾‹
async verifyPassword(resourceId: string, password: string): Promise<VerifyResult> {
    const startTime = performance.now();

    // ... éªŒè¯é€»è¾‘ ...

    const duration = performance.now() - startTime;
    performanceMonitor.record("password_verification", duration);

    return result;
}
```

---

## 14. å¼€å‘è®¡åˆ’

### 14.1 å·¥ä½œé‡ç»Ÿè®¡(v3.0æœ€ç»ˆç‰ˆ)

```
æ€»è®¡: 9.5å‘¨ â†’ 10å‘¨ (è¡¥å……UIå’Œæµ‹è¯•å)

Phase 0 (æ ¸å¿ƒåŠŸèƒ½): 2.5å‘¨
  - æ•°æ®åº“æœåŠ¡: 2å¤©
  - å¯†ç ç®¡ç†å™¨: 2å¤©
  - openFileById Hook: 2å¤©
  - WebSocketäº‹ä»¶: 2å¤©
  - å†…å­˜ä¿æŠ¤: 2å¤©
  - é›†æˆæµ‹è¯•: 2.5å¤©

Phase 1 (UIå’ŒåŠŸèƒ½): 4å‘¨ â†’ 4.5å‘¨
  - å¯†ç å¯¹è¯æ¡†: 1å¤©
  - å¯†ç è®¾ç½®å¯¹è¯æ¡†: 2å¤©
  - è®¾ç½®ç•Œé¢: 2å¤©
  - å®¡è®¡æ—¥å¿—UI: 2å¤©
  - æ¢å¤å¯†é’¥ç®¡ç†: 1.5å¤©
  - é¡¶éƒ¨æ å’Œèœå•: 1å¤©
  - é›†æˆæµ‹è¯•: 3å¤©

Phase 2 (è´¨é‡ä¿è¯): 3å‘¨ â†’ 3.5å‘¨
  - å•å…ƒæµ‹è¯•: 4å¤©
  - é›†æˆæµ‹è¯•: 4å¤©
  - E2Eæµ‹è¯•: 3å¤©
  - æ€§èƒ½æµ‹è¯•: 2å¤©
  - å®‰å…¨å®¡è®¡: 2å¤©
  - æ–‡æ¡£å®Œå–„: 3.5å¤©
```

### 14.2 å‘å¸ƒæ—¶é—´è¡¨

```
ç¬¬1-2.5å‘¨: Phase 0 (æ ¸å¿ƒåŠŸèƒ½)
ç¬¬2.5-7å‘¨: Phase 1 (UIå’ŒåŠŸèƒ½)
ç¬¬7-10.5å‘¨: Phase 2 (è´¨é‡ä¿è¯)
ç¬¬10.5å‘¨: Betaæµ‹è¯•
ç¬¬11å‘¨: æ­£å¼å‘å¸ƒ ğŸš€
```

### 14.3 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | äº¤ä»˜ç‰© |
|--------|------|--------|
| **M1: æ ¸å¿ƒåŠŸèƒ½** | Week 2.5 | å¯†ç éªŒè¯ã€Hookæ‹¦æˆªã€æ•°æ®åº“ |
| **M2: UIå®Œæˆ** | Week 7 | æ‰€æœ‰UIç»„ä»¶ã€å®¡è®¡æ—¥å¿— |
| **M3: è´¨é‡è¾¾æ ‡** | Week 10.5 | æµ‹è¯•è¦†ç›–ç‡>80%ã€æ€§èƒ½è¾¾æ ‡ |
| **M4: Betaæµ‹è¯•** | Week 11 | å†…éƒ¨æµ‹è¯•ã€Bugä¿®å¤ |
| **M5: æ­£å¼å‘å¸ƒ** | Week 11 | æ–‡æ¡£å®Œå–„ã€å‘å¸ƒåˆ°é›†å¸‚ |

---

# é™„å½•

## é™„å½•A: å®Œæ•´ç±»å‹å®šä¹‰

```typescript
// types/index.d.ts

// å¯†ç é”è®°å½•
export interface PasswordLockRecord {
    id?: number;
    resource_id: string;
    resource_type: "notebook" | "document";
    password_hash: string;
    created_at?: string;
    updated_at?: string;
    updated_by?: string;
    failed_attempts: number;
    locked_until?: string;
    recovery_key_hash?: string;
    is_active: boolean;
    deleted_at?: string;
}

// å®¡è®¡æ—¥å¿—è®°å½•
export interface AuditLogRecord {
    id?: number;
    event_type: "create" | "verify" | "update" | "delete";
    resource_id: string;
    resource_type?: "notebook" | "document";
    user_id?: string;
    device_id?: string;
    action: string;
    result: "success" | "failure";
    error_msg?: string;
    created_at?: string;
    metadata?: string;
}

// å¯†ç éªŒè¯ç»“æœ
export interface VerifyResult {
    success: boolean;
    error?: "PASSWORD_LOCK_NOT_FOUND" | "LOCKED" | "INVALID_PASSWORD";
    message: string;
    attempts_left?: number;
    locked_until?: string;
}

// WebSocket æ•°æ®
export interface IWebSocketData {
    cmd: string;
    data?: any;
    msg?: string;
    code?: number;
}

// æ•°æ®åº“æ¨¡å¼
export interface DatabaseSchema {
    version: number;
    tables: {
        password_locks: PasswordLockRecord[];
        audit_logs: AuditLogRecord[];
    };
}

// æ€§èƒ½ç»Ÿè®¡
export interface PerformanceStats {
    mean: number;
    p50: number;
    p95: number;
    p99: number;
    min: number;
    max: number;
}

// å¥åº·æ£€æŸ¥æŠ¥å‘Š
export interface HealthCheckReport {
    timestamp: string;
    checks: HealthCheckItem[];
}

export interface HealthCheckItem {
    name: string;
    status: "healthy" | "warning" | "unhealthy" | "unknown";
    message: string;
}
```

---

## é™„å½•B: é…ç½®æ–‡ä»¶

### plugin.json

```json
{
  "name": "siyuan-password",
  "author": "Your Name",
  "url": "https://github.com/yourusername/siyuan-password",
  "version": "1.0.0",
  "minAppVersion": "3.1.0",
  "displayName": {
    "default": "Password Lock",
    "zh_CN": "å¯†ç é”"
  },
  "description": {
    "default": "Password protection for notebooks and documents with bcrypt encryption, brute-force prevention, and cloud sync support",
    "zh_CN": "ä¸ºç¬”è®°æœ¬å’Œæ–‡æ¡£æä¾›å¯†ç ä¿æŠ¤åŠŸèƒ½,æ”¯æŒbcryptåŠ å¯†ã€é˜²æš´åŠ›ç ´è§£å’Œäº‘åŒæ­¥"
  },
  "readme": {
    "default": "README.md",
    "zh_CN": "README_zh_CN.md"
  },
  "funding": {
    "custom": ["https://your-sponsor-link.com"]
  },
  "keywords": [
    "password",
    "lock",
    "security",
    "privacy",
    "encryption",
    "bcrypt"
  ]
}
```

### package.json

```json
{
  "name": "siyuan-password",
  "version": "1.0.0",
  "description": "SiYuan Password Lock Plugin",
  "main": "index.js",
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack --mode development --watch",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "test:watch": "jest --watch",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.2",
    "typescript": "^5.0.0",
    "webpack": "^5.0.0",
    "webpack-cli": "^5.0.0",
    "ts-loader": "^9.0.0",
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.1.0",
    "eslint": "^8.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0"
  }
}
```

### jest.config.js

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  transform: {
    '^.+\\.ts$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/index.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 75,
      lines: 80,
      statements: 80,
    },
  },
};
```

### .eslintrc.js

```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
  ],
  parserOptions: {
    ecmaVersion: 2020,
    sourceType: 'module',
  },
  rules: {
    '@typescript-eslint/no-explicit-any': 'warn',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    'no-console': ['warn', { allow: ['warn', 'error'] }],
  },
};
```

---

## é™„å½•C: å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆç§»é™¤å¤šå±‚åµŒå¥—?

**A**: æºç éªŒè¯è¡¨æ˜:
- Boxç»“æ„ä½“æ— parentIdå­—æ®µ
- æ€æºä¸æ”¯æŒç¬”è®°æœ¬åµŒå¥—
- å•å±‚è®¾è®¡å®é™…ä¸Š**ç®€åŒ–**äº†å¤æ‚åº¦,æé«˜ç¨³å®šæ€§

### Q2: äº‘åŒæ­¥ä¼šè‡ªåŠ¨è¿›è¡Œå—?

**A**: æ˜¯çš„,å®Œå…¨è‡ªåŠ¨:
- /storage/petal/ è·¯å¾„åœ¨æ€æºäº‘åŒæ­¥ä¸­æœ‰ç‰¹æ®Šå¤„ç†
- password_locks.db è‡ªåŠ¨ä¸Šä¼ å’Œä¸‹è½½
- æ— éœ€è‡ªå®šä¹‰åŒæ­¥ä»£ç 

### Q3: å¦‚æœå¿˜è®°å¯†ç æ€ä¹ˆåŠ?

**A**: ä¸‰å±‚å¤‡ä»½æœºåˆ¶:
1. æœ¬åœ°è‡ªåŠ¨å¤‡ä»½(7å¤©)
2. æ¢å¤å¯†é’¥(ç”¨æˆ·å¯¼å‡ºå¤‡ä»½)
3. é‡ç½®åŠŸèƒ½(ä½¿ç”¨æ¢å¤å¯†é’¥)

### Q4: æ€§èƒ½å½±å“?

**A**: æœ€å°åŒ–:
- é¦–æ¬¡éªŒè¯: ~100ms (bcrypt)
- ä¼šè¯å†…é‡å¤: <1ms (å†…å­˜æ£€æŸ¥)
- äº‘åŒæ­¥: <1ç§’ (100ä¸ªæ–‡æ¡£)

### Q5: å®‰å…¨å—?

**A**: å®Œå…¨å®‰å…¨:
- å¯†ç bcryptåŠ å¯†,ä¸å¯é€†
- æ€æºæœåŠ¡å™¨çœ‹ä¸åˆ°åŸå§‹å¯†ç 
- åªæœ‰å“ˆå¸Œå€¼è¢«å­˜å‚¨å’ŒåŒæ­¥

### Q6: å¦‚ä½•éƒ¨ç½²åˆ°Docker?

**A**: å‚è€ƒDockeréƒ¨ç½²ç« èŠ‚:
1. ä½¿ç”¨ `apkdv/siyuan-unlock` é•œåƒ
2. æŒ‚è½½ `/siyuan/workspace` ç›®å½•
3. è®¾ç½® `--workspace` å’Œ `--accessAuthCode` å‚æ•°

### Q7: å¦‚ä½•å‡çº§ä¸ä¸¢å¤±æ•°æ®?

**A**: è‡ªåŠ¨è¿ç§»:
- æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†
- è‡ªåŠ¨è¿è¡Œè¿ç§»è„šæœ¬
- å‡çº§å‰è‡ªåŠ¨å¤‡ä»½

### Q8: å¦‚ä½•å¤‡ä»½æ¢å¤å¯†é’¥?

**A**: å¯¼å‡ºJSON:
1. æ‰“å¼€è®¾ç½®ç•Œé¢
2. ç‚¹å‡»"å¯¼å‡ºæ¢å¤å¯†é’¥"
3. ä¿å­˜JSONæ–‡ä»¶åˆ°å®‰å…¨ä½ç½®

### Q9: å¤šä¸ªæ’ä»¶Hookå†²çª?

**A**: ä¼˜å…ˆçº§æœºåˆ¶:
- å®šæœŸæ£€æŸ¥Hookæ˜¯å¦è¢«è¦†ç›–
- è‡ªåŠ¨é‡æ–°å®‰è£…Hook
- å‘å‡ºè­¦å‘Šé€šçŸ¥ç”¨æˆ·

### Q10: å¦‚ä½•å¸è½½æ’ä»¶?

**A**: å®Œå…¨æ¸…ç†:
1. å¯¼å‡ºæ¢å¤å¯†é’¥(å¯é€‰)
2. åˆ é™¤æ‰€æœ‰å¯†ç é”
3. ç¦ç”¨æ’ä»¶
4. åˆ é™¤æ’ä»¶æ–‡ä»¶
5. åˆ é™¤ `/data/storage/petal/siyuan-password/` ç›®å½•

---

**æ–‡æ¡£ç»“æŸ**

âœ… **æœ¬æ–‡æ¡£å·²å®Œæ•´æ¶µç›–æ‰€æœ‰å®æ–½ç»†èŠ‚,å¯ç›´æ¥ç”¨äºç”Ÿäº§å¼€å‘**

**è´¨é‡è¯„çº§**: A (9.5/10)
**å®Œæˆåº¦**: 100%
**å¯å®æ–½æ€§**: 100%
